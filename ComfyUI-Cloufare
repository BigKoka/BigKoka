# ComfyUI Colab Setup Script vá»›i Cloudflared cáº£i tiáº¿n vÃ  má»Ÿ rá»™ng

import os
import subprocess
import time
import requests
import re
from google.colab import drive
from google.colab import output

# @title # âš™ï¸ 1. Mount Google Drive vÃ  CÃ i Ä‘áº·t
print("Äang mount Google Drive...")
drive.mount('/content/drive')

print("Äang cÃ i Ä‘áº·t cloudflared...")
!wget -q -c https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
!dpkg -i cloudflared-linux-amd64.deb

# @title # âš™ï¸ 2. Chá»n phiÃªn báº£n ComfyUI
# @markdown Chá»n phiÃªn báº£n ComfyUI Ä‘á»ƒ cÃ i Ä‘áº·t
version = "latest" #@param ["latest", "v1.0", "v1.1", "v1.2"]

# @title # âŒ›ï¸ 3. CÃ i Ä‘áº·t ComfyUI vÃ  cÃ¡c dependencies
comfyui_folder = '/content/drive/MyDrive/ComfyUI'

def run_command(command):
    process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True, universal_newlines=True)
    output, error = process.communicate()
    if process.returncode != 0:
        print(f"Lá»—i khi cháº¡y lá»‡nh: {command}")
        print(f"Output: {output}")
        print(f"Error: {error}")
        return False
    return True

print(f"Äang cÃ i Ä‘áº·t ComfyUI phiÃªn báº£n {version}...")
if not os.path.exists(comfyui_folder):
    os.makedirs(comfyui_folder)

if version == "latest":
    clone_command = f"git clone https://github.com/comfyanonymous/ComfyUI.git {comfyui_folder}"
else:
    clone_command = f"git clone --branch {version} https://github.com/comfyanonymous/ComfyUI.git {comfyui_folder}"

if not run_command(clone_command):
    print("KhÃ´ng thá»ƒ clone repository ComfyUI. Kiá»ƒm tra káº¿t ná»‘i máº¡ng vÃ  thá»­ láº¡i.")
    exit(1)

print("Äang cÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n phá»¥ thuá»™c...")
os.chdir(comfyui_folder)
if not run_command("pip install -r requirements.txt"):
    print("KhÃ´ng thá»ƒ cÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n phá»¥ thuá»™c. Kiá»ƒm tra láº¡i requirements.txt vÃ  thá»­ láº¡i.")
    exit(1)

# @title # ğŸš€ 4. Khá»Ÿi cháº¡y ComfyUI vÃ  Cloudflared
def is_comfyui_ready():
    try:
        response = requests.get('http://localhost:8188')
        return response.status_code == 200
    except:
        return False

def get_cloudflared_url():
    process = subprocess.Popen(['cloudflared', 'tunnel', '--url', 'http://localhost:8188'],
                               stdout=subprocess.PIPE,
                               stderr=subprocess.STDOUT,
                               universal_newlines=True)

    for line in process.stdout:
        print(line.strip())
        match = re.search(r'(https://.*\.trycloudflare\.com)', line)
        if match:
            return match.group(1)

    return None

print("Äang khá»Ÿi Ä‘á»™ng ComfyUI...")
comfyui_process = subprocess.Popen(['python', 'main.py'], cwd=comfyui_folder, stdout=subprocess.PIPE, stderr=subprocess.PIPE)

print("Äang Ä‘á»£i ComfyUI khá»Ÿi Ä‘á»™ng...")
timeout = 300  # 5 phÃºt
start_time = time.time()
while not is_comfyui_ready():
    if time.time() - start_time > timeout:
        print("ComfyUI khÃ´ng khá»Ÿi Ä‘á»™ng Ä‘Æ°á»£c trong thá»i gian chá». Äang in logs...")
        output, error = comfyui_process.communicate()
        print("Output:", output.decode())
        print("Error:", error.decode())
        exit(1)
    time.sleep(5)
    print(".", end="", flush=True)

print("\nComfyUI Ä‘Ã£ sáºµn sÃ ng!")

print("Äang khá»Ÿi Ä‘á»™ng Cloudflared vÃ  láº¥y URL...")
url = get_cloudflared_url()
if url:
    print(f"ComfyUI cÃ³ thá»ƒ truy cáº­p táº¡i URL: {url}")
else:
    print("KhÃ´ng thá»ƒ láº¥y Ä‘Æ°á»£c URL tá»« Cloudflared. Äang thá»­ cÃ¡c phÆ°Æ¡ng Ã¡n khÃ¡c...")

    print("Kiá»ƒm tra port forwarding cá»§a Google Colab...")
    output.serve_kernel_port_as_window(8188)
    print("Vui lÃ²ng kiá»ƒm tra URL Ä‘Æ°á»£c táº¡o bá»Ÿi Colab á»Ÿ trÃªn.")

    print("Náº¿u báº¡n váº«n khÃ´ng tháº¥y URL, hÃ£y kiá»ƒm tra tab 'Tools' > 'Ports' trong Google Colab Ä‘á»ƒ tÃ¬m URL truy cáº­p cho cá»•ng 8188.")

# Biáº¿n Ä‘á»ƒ theo dÃµi tráº¡ng thÃ¡i
url_displayed = bool(url)

# Giá»¯ cho notebook cháº¡y vÃ  kiá»ƒm tra tráº¡ng thÃ¡i
while True:
    time.sleep(60)
    if comfyui_process.poll() is not None:
        print("ComfyUI Ä‘Ã£ dá»«ng hoáº¡t Ä‘á»™ng. Äang khá»Ÿi Ä‘á»™ng láº¡i...")
        comfyui_process = subprocess.Popen(['python', 'main.py'], cwd=comfyui_folder)

    if not is_comfyui_ready():
        print("ComfyUI khÃ´ng pháº£n há»“i. Äang thá»­ khá»Ÿi Ä‘á»™ng láº¡i...")
        comfyui_process = subprocess.Popen(['python', 'main.py'], cwd=comfyui_folder)

    if not url_displayed:
        url = get_cloudflared_url()
        if url:
            print(f"ComfyUI cÃ³ thá»ƒ truy cáº­p táº¡i URL: {url}")
            url_displayed = True

    print("ComfyUI vÃ  Cloudflared Ä‘ang cháº¡y...", flush=True)
